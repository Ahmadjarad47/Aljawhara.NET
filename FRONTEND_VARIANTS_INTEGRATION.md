# دليل تكامل نظام Variants للمنتجات - Frontend Integration Guide

## نظرة عامة
تم إضافة نظام Variants للمنتجات بحيث يمكن لكل منتج أن يحتوي على متغيرات متعددة (مثل: الحجم، اللون، المادة) وكل متغير يحتوي على قيم متعددة، وكل قيمة لها سعر مستقل بديل عن سعر المنتج الأساسي.

---

## 1. البنية الجديدة (Data Structure)

### 1.1 ProductVariant (المتغير)
يمثل نوع المتغير مثل "الحجم" أو "اللون"

**الحقول:**
- `id` (number, optional): معرف المتغير (يُستخدم عند التحديث)
- `name` (string, required): اسم المتغير بالإنجليزية (مثال: "Size", "Color")
- `nameAr` (string, required): اسم المتغير بالعربية (مثال: "حجم", "لون")
- `productId` (number, optional): معرف المنتج (يُضاف تلقائياً)
- `values` (array): قائمة القيم لهذا المتغير

### 1.2 ProductVariantValue (قيمة المتغير)
يمثل قيمة محددة للمتغير مثل "Large" أو "Red"

**الحقول:**
- `id` (number, optional): معرف القيمة (يُستخدم عند التحديث)
- `value` (string, required): القيمة بالإنجليزية (مثال: "Large", "Red")
- `valueAr` (string, required): القيمة بالعربية (مثال: "كبير", "أحمر")
- `price` (decimal, required): السعر البديل لهذه القيمة (يجب أن يكون أكبر من 0)
- `productVariantId` (number, optional): معرف المتغير (يُضاف تلقائياً)

---

## 2. التعديلات على DTOs الموجودة

### 2.1 ProductDto (عند جلب المنتج)
تمت إضافة حقل جديد:
- `variants` (array of ProductVariantDto): قائمة جميع المتغيرات مع قيمها

**مثال على الاستجابة:**
```json
{
  "id": 1,
  "title": "T-Shirt",
  "newPrice": 100,
  "variants": [
    {
      "id": 1,
      "name": "Size",
      "nameAr": "حجم",
      "values": [
        {
          "id": 1,
          "value": "Small",
          "valueAr": "صغير",
          "price": 100
        },
        {
          "id": 2,
          "value": "Large",
          "valueAr": "كبير",
          "price": 120
        }
      ]
    },
    {
      "id": 2,
      "name": "Color",
      "nameAr": "لون",
      "values": [
        {
          "id": 3,
          "value": "Red",
          "valueAr": "أحمر",
          "price": 100
        },
        {
          "id": 4,
          "value": "Blue",
          "valueAr": "أزرق",
          "price": 110
        }
      ]
    }
  ]
}
```

### 2.2 ProductCreateDto (عند إنشاء منتج جديد)
تمت إضافة حقل جديد:
- `variants` (array of ProductVariantCreateDto, optional): قائمة المتغيرات الجديدة

**ملاحظات:**
- الحقل اختياري (يمكن إنشاء منتج بدون variants)
- عند الإنشاء، لا حاجة لإرسال `id` لأنها ستُضاف تلقائياً
- يجب إرسال `productId` و `productVariantId` كقيم فارغة أو 0

### 2.3 ProductUpdateDto (عند تحديث منتج)
تمت إضافة حقل جديد:
- `variants` (array of ProductVariantUpdateDto, optional): قائمة المتغيرات المحدثة

**آلية التحديث:**
- عند التحديث، يتم حذف جميع Variants القديمة وإضافة الجديدة
- إذا كان `id` موجود: يتم تحديث المتغير/القيمة الموجودة
- إذا كان `id` null أو غير موجود: يتم إنشاء متغير/قيمة جديدة
- إذا لم ترسل Variants: يتم حذف جميع Variants الموجودة

### 2.4 ProductCreateWithFilesDto و ProductUpdateWithFilesDto
نفس التعديلات السابقة مع إضافة دعم رفع الملفات

---

## 3. آلية العمل (How It Works)

### 3.1 عند إنشاء منتج جديد:
1. ترسل بيانات المنتج الأساسية (العنوان، الوصف، السعر، إلخ)
2. ترسل قائمة Variants (إن وجدت)
3. لكل Variant ترسل:
   - الاسم بالإنجليزية والعربية
   - قائمة Values
4. لكل Value ترسل:
   - القيمة بالإنجليزية والعربية
   - السعر البديل
5. النظام يقوم تلقائياً بربط Variants بالمنتج وربط Values بالـ Variants

### 3.2 عند تحديث منتج:
1. ترسل بيانات المنتج المحدثة
2. ترسل قائمة Variants الجديدة (كاملة)
3. النظام يقوم بـ:
   - حذف جميع Variants القديمة
   - إضافة Variants الجديدة
   - ربطها بالمنتج

**مهم:** عند التحديث، يجب إرسال جميع Variants (القديمة والجديدة) لأن النظام يحذف القديمة ويضيف الجديدة.

### 3.3 عند جلب منتج:
1. عند استدعاء أي endpoint لجلب منتج (GET)
2. يتم إرجاع المنتج مع جميع Variants و Values المرتبطة به
3. يمكن استخدام هذه البيانات لعرض خيارات الاختيار للمستخدم

---

## 4. استخدام السعر البديل

### 4.1 السعر الأساسي:
- `newPrice` في ProductDto هو السعر الأساسي للمنتج

### 4.2 السعر البديل:
- كل Value في Variant لها `price` خاص بها
- هذا السعر هو السعر البديل الذي يحل محل السعر الأساسي عند اختيار هذه القيمة

### 4.3 آلية حساب السعر النهائي:
1. ابدأ بالسعر الأساسي (`newPrice`)
2. عند اختيار المستخدم لقيمة من Variant:
   - استبدل السعر بسعر القيمة المختارة (`value.price`)
3. إذا كان المنتج يحتوي على عدة Variants:
   - السعر النهائي = سعر آخر قيمة تم اختيارها
   - أو يمكن استخدام منطق آخر حسب متطلبات العمل

**مثال:**
- سعر المنتج الأساسي: 100 SAR
- المستخدم يختار "Large" (سعرها: 120 SAR)
- السعر النهائي: 120 SAR
- المستخدم يختار "Blue" (سعرها: 110 SAR)
- السعر النهائي: 110 SAR (آخر اختيار)

---

## 5. Endpoints المتأثرة

### 5.1 Endpoints التي ترجع Variants:
- `GET /api/products/{id}` - جلب منتج واحد
- `GET /api/admin/products/{id}` - جلب منتج واحد (Admin)
- `GET /api/products` - جلب جميع المنتجات
- `GET /api/admin/products` - جلب جميع المنتجات (Admin)
- جميع endpoints جلب المنتجات ترجع Variants

### 5.2 Endpoints التي تقبل Variants:
- `POST /api/admin/products` - إنشاء منتج جديد
- `PUT /api/admin/products/{id}` - تحديث منتج

**ملاحظة:** Endpoints المستخدمة من قبل المستخدمين العاديين (غير Admin) لا تقبل إنشاء/تحديث Variants، فقط القراءة.

---

## 6. متطلبات Frontend

### 6.1 عند عرض صفحة المنتج:
1. عرض معلومات المنتج الأساسية
2. إذا كان المنتج يحتوي على Variants:
   - عرض كل Variant كمجموعة خيارات
   - لكل Variant عرض قائمة Values كأزرار أو قائمة منسدلة
   - عند اختيار Value، تحديث السعر المعروض
   - التأكد من اختيار قيمة واحدة على الأقل من كل Variant قبل الإضافة للسلة

### 6.2 عند إنشاء/تحديث منتج (Admin):
1. إضافة قسم "Variants" في نموذج المنتج
2. إمكانية إضافة/حذف Variants
3. لكل Variant:
   - حقول: Name (EN), NameAr (AR)
   - إمكانية إضافة/حذف Values
4. لكل Value:
   - حقول: Value (EN), ValueAr (AR), Price
5. عند الحفظ، إرسال جميع Variants مع البيانات

### 6.3 عند إضافة منتج للسلة:
1. يجب حفظ Variants المختارة مع المنتج
2. إرسال:
   - `productId`
   - `selectedVariants`: object يحتوي على `{ variantId: valueId }`
   - `finalPrice`: السعر النهائي بعد اختيار Variants

---

## 7. أمثلة على البيانات المرسلة

### 7.1 إنشاء منتج مع Variants:
```json
{
  "title": "T-Shirt",
  "titleAr": "قميص",
  "description": "Cotton T-Shirt",
  "descriptionAr": "قميص قطني",
  "oldPrice": 150,
  "newPrice": 100,
  "isInStock": true,
  "totalInStock": 50,
  "subCategoryId": 1,
  "productDetails": [],
  "variants": [
    {
      "name": "Size",
      "nameAr": "حجم",
      "values": [
        {
          "value": "Small",
          "valueAr": "صغير",
          "price": 100
        },
        {
          "value": "Large",
          "valueAr": "كبير",
          "price": 120
        }
      ]
    }
  ]
}
```

### 7.2 تحديث منتج مع Variants:
```json
{
  "id": 1,
  "title": "T-Shirt Updated",
  "variants": [
    {
      "id": 1,  // موجود = تحديث
      "name": "Size",
      "nameAr": "حجم",
      "values": [
        {
          "id": 1,  // موجود = تحديث
          "value": "Small",
          "valueAr": "صغير",
          "price": 100
        },
        {
          // بدون id = جديد
          "value": "XLarge",
          "valueAr": "كبير جداً",
          "price": 130
        }
      ]
    },
    {
      // بدون id = جديد
      "name": "Color",
      "nameAr": "لون",
      "values": [
        {
          "value": "Red",
          "valueAr": "أحمر",
          "price": 100
        }
      ]
    }
  ]
}
```

---

## 8. Validation Rules (قواعد التحقق)

### 8.1 عند الإنشاء:
- `name` و `nameAr` مطلوبان لكل Variant
- `value` و `valueAr` مطلوبان لكل Value
- `price` مطلوب ويجب أن يكون أكبر من 0.01
- يمكن إنشاء منتج بدون Variants (اختياري)

### 8.2 عند التحديث:
- نفس القواعد السابقة
- إذا أرسلت `variants` فارغة `[]`: سيتم حذف جميع Variants

---

## 9. ملاحظات مهمة

1. **عند استخدام FormData:**
   - عند إرسال Variants مع FormData (لرفع الصور)، يجب إرسالها كـ JSON string:
   ```javascript
   formData.append('variants', JSON.stringify(variants));
   ```

2. **عند التحديث:**
   - النظام يحذف جميع Variants القديمة ويضيف الجديدة
   - إذا أردت الاحتفاظ ببعض Variants، يجب إرسالها في الطلب

3. **السعر البديل:**
   - السعر في Value يحل محل السعر الأساسي
   - إذا لم يختر المستخدم أي Value، استخدم السعر الأساسي

4. **الترتيب:**
   - Variants و Values تُحفظ بالترتيب الذي أرسلته
   - الترتيب يُحفظ في قاعدة البيانات

---

## 10. Checklist للفرونت إند

- [ ] تحديث Types/Interfaces لإضافة Variants
- [ ] تحديث صفحة عرض المنتج لعرض Variants
- [ ] إضافة منطق اختيار Variants وتحديث السعر
- [ ] تحديث نموذج إنشاء/تحديث المنتج (Admin)
- [ ] إضافة واجهة إدارة Variants (إضافة/حذف/تعديل)
- [ ] تحديث API calls لإرسال/استقبال Variants
- [ ] تحديث منطق إضافة المنتج للسلة ليشمل Variants المختارة
- [ ] إضافة Validation للـ Variants في الفرونت إند
- [ ] اختبار جميع السيناريوهات (إنشاء، تحديث، عرض، شراء)

---

## 11. أمثلة على حالات الاستخدام

### 11.1 منتج بدون Variants:
- يعمل كالمعتاد
- السعر الأساسي فقط

### 11.2 منتج مع Variant واحد (Size):
- المستخدم يختار الحجم
- السعر يتغير حسب الحجم المختار

### 11.3 منتج مع عدة Variants (Size + Color):
- المستخدم يختار الحجم واللون
- السعر يتغير حسب آخر اختيار (أو حسب منطق العمل)

---

## 12. نصائح للتنفيذ

1. **استخدم State Management:**
   - احفظ Variants المختارة في state
   - حدّث السعر تلقائياً عند تغيير الاختيار

2. **UX Considerations:**
   - اعرض السعر القديم والجديد عند اختيار Variant
   - أظهر الفرق في السعر (+10 SAR أو -5 SAR)
   - اجعل اختيار Variants واضحاً وسهلاً

3. **Error Handling:**
   - تأكد من اختيار قيمة من كل Variant قبل الإضافة للسلة
   - اعرض رسائل خطأ واضحة

4. **Performance:**
   - لا تحمّل Variants إلا عند الحاجة
   - استخدم lazy loading إذا كان هناك الكثير من Variants

---

## الخلاصة

تم إضافة نظام Variants كامل للمنتجات يدعم:
- متغيرات متعددة لكل منتج
- قيم متعددة لكل متغير
- سعر مستقل لكل قيمة
- دعم كامل للغة العربية والإنجليزية
- تكامل كامل مع جميع endpoints الموجودة

النظام جاهز للاستخدام ويحتاج فقط إلى تحديث الفرونت إند ليتناسق مع البنية الجديدة.

